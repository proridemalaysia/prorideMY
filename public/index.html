<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Proride Parts — Full CSV & Images</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
    .modal-enter { transform: translateY(100vh); }
    .modal-enter-active { transform: translateY(0); transition: transform 0.28s ease-in-out; }
    .modal-fade { opacity: 0; transition: opacity 0.18s ease-in-out; }
    .modal-fade.show { opacity: 1; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

  <div id="app-container" class="bg-white rounded-3xl shadow-2xl p-6 max-w-lg w-full">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-gray-800">Proride Parts</h1>
      <button id="cart-button" class="relative bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg transition duration-300 active:scale-95">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l3 12h11l3-8H7" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21a1 1 0 100-2 1 1 0 000 2zm10 0a1 1 0 100-2 1 1 0 000 2z" />
        </svg>
        <span id="cart-item-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
      </button>
    </div>

    <div class="mb-6 rounded-xl overflow-hidden shadow-lg">
      <img id="product-main-image" src="https://placehold.co/800x800/e5e7eb/6b7280?text=Select+Car+Model" alt="Main product image placeholder" class="w-full h-auto object-cover">
    </div>

    <div class="flex space-x-4 mb-6">
      <div class="flex-1">
        <label for="car-model" class="block text-sm font-medium text-gray-700 mb-1">Car Model</label>
        <select id="car-model" class="w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"></select>
      </div>
      <div class="flex-1">
        <label for="product-type" class="block text-sm font-medium text-gray-700 mb-1">Product Type</label>
        <select id="product-type" class="w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"></select>
      </div>
    </div>

    <div id="product-list"></div>
  </div>

  <!-- Cart Modal -->
  <div id="cart-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-70 flex items-end hidden">
    <div id="cart-modal-panel" class="relative bg-white w-full rounded-t-3xl shadow-2xl p-6 modal-enter">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-800">Your Cart</h3>
        <button id="close-cart" class="text-gray-400 hover:text-gray-600 text-2xl font-bold p-2 leading-none rounded-full transition-colors">&times;</button>
      </div>
      <div id="cart-items" class="max-h-64 overflow-y-auto mb-6 space-y-2"></div>
      <div class="flex justify-between items-center text-xl font-bold border-t pt-4">
        <span>Total:</span>
        <span id="cart-total">RM 0.00</span>
      </div>
      <button id="checkout-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 mt-4 rounded-xl transition duration-300 active:scale-98 opacity-50 cursor-not-allowed" disabled>
        Proceed to Checkout
      </button>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkout-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-70 flex items-end hidden">
    <div id="checkout-modal-panel" class="relative bg-white w-full rounded-t-3xl shadow-2xl p-6 modal-enter">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-800">Checkout</h3>
        <button id="close-checkout" class="text-gray-400 hover:text-gray-600 text-2xl font-bold p-2 leading-none rounded-full transition-colors">&times;</button>
      </div>

      <div class="mb-6 space-y-3">
        <h4 class="text-lg font-bold text-gray-800 border-b pb-2">Customer Information</h4>
        <div>
          <label for="name" class="text-sm font-medium text-gray-700 block mb-1">Full Name</label>
          <input type="text" id="name" placeholder="Your Name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
  <label for="address" class="text-sm font-medium text-gray-700 block mb-1">Delivery Address</label>
  <input type="text" id="address" placeholder="Street, City, State" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
</div>
<div>
  <label for="postcode" class="text-sm font-medium text-gray-700 block mb-1">Postcode</label>
  <input type="text" id="postcode" placeholder="e.g., 50000" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
</div>

        <div>
          <label for="email" class="text-sm font-medium text-gray-700 block mb-1">Email</label>
          <input type="email" id="email" placeholder="you@example.com" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label for="phone" class="text-sm font-medium text-gray-700 block mb-1">Phone Number</label>
          <input type="tel" id="phone" placeholder="e.g., 60123456789" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>

      <div id="checkout-summary" class="max-h-64 overflow-y-auto mb-6"></div>
    <!-- ✅ Place courier options here -->
    <div id="courier-options" class="mb-4"></div>
      
      <button id="pay-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl transition duration-300 active:scale-98">Proceed to Payment</button>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmation-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-70 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center transform scale-90 transition-transform duration-300">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-500 mx-auto mb-4" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
      </svg>
      <h3 class="text-2xl font-bold text-gray-800 mb-2">Payment Successful</h3>
      <p class="text-gray-600 mb-6">Thank you for your order. Your transaction has been completed successfully.</p>
      <button id="close-confirmation" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-300 active:scale-95">Continue Shopping</button>
    </div>
  </div>

  <script>
  async function loadData() {
    const productsRes = await fetch('/data/products.json');
    const products = await productsRes.json();

    const imagesRes = await fetch('/data/images.json');
    const imageMap = await imagesRes.json();

    const modelsRes = await fetch('/data/models.json');
    const modelMapping = await modelsRes.json();

    return { products, imageMap, modelMapping };
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const { products, imageMap } = await loadData();

    // Core UI elements
    const productListEl = document.getElementById('product-list');
    const carModelSelect = document.getElementById('car-model');
    const productTypeSelect = document.getElementById('product-type');
    const productMainImageEl = document.getElementById('product-main-image');

    // Cart / checkout UI elements
    const cartButton = document.getElementById('cart-button');
    const cartModal = document.getElementById('cart-modal');
    const closeCartBtn = document.getElementById('close-cart');
    const checkoutButton = document.getElementById('checkout-button');
    const checkoutModal = document.getElementById('checkout-modal');
    const closeCheckoutBtn = document.getElementById('close-checkout');
    const confirmationModal = document.getElementById('confirmation-modal');
    const closeConfirmationBtn = document.getElementById('close-confirmation');
    const payButton = document.getElementById('pay-button');

    const cartItemsEl = document.getElementById('cart-items');
    const cartTotalEl = document.getElementById('cart-total');
    const cartItemCountEl = document.getElementById('cart-item-count');
    const checkoutSummaryEl = document.getElementById('checkout-summary');
    const courierOptionsEl = document.getElementById('courier-options');

    let cart = [];
    const productTypeOrder = ['Standard Absorber', 'Heavy Duty Absorber', 'Performance Absorber', 'Sport Spring'];

    // Build car model dropdown
    const uniqueModels = [...new Set(products.map(p => p.MODEL))].sort();
    carModelSelect.innerHTML = uniqueModels.map(m => `<option value="${m}">${m}</option>`).join('');

    function updateProductTypeDropdown() {
      const selectedModel = carModelSelect.value;
      const typesForModel = [...new Set(products
        .filter(p => p.MODEL === selectedModel)
        .map(p => {
          const v = p.VARIANT.toUpperCase();
          if (v.includes('STANDARD')) return 'Standard Absorber';
          if (v.includes('HEAVY DUTY')) return 'Heavy Duty Absorber';
          if (v.includes('PERFORMANCE')) return 'Performance Absorber';
          if (v.includes('SPORT')) return 'Sport Spring';
          return null;
        })
        .filter(Boolean)
      )];

      const orderedTypes = productTypeOrder.filter(t => typesForModel.includes(t));
      productTypeSelect.innerHTML = orderedTypes.map(t => `<option value="${t}">${t.toUpperCase()}</option>`).join('');
      renderProducts();
    }

    function renderProducts() {
      const selectedModel = carModelSelect.value;
      const selectedType = productTypeSelect.value;
      const key = `${selectedModel}-${selectedType}`;

      productMainImageEl.src = imageMap[key] || 'https://placehold.co/800x800/e5e7eb/6b7280?text=No+Image';
      productMainImageEl.alt = key;

      const filtered = products.filter(p => {
        const variant = p.VARIANT.toUpperCase();
        let type = '';
        if (variant.includes('STANDARD')) type = 'Standard Absorber';
        else if (variant.includes('HEAVY DUTY')) type = 'Heavy Duty Absorber';
        else if (variant.includes('PERFORMANCE')) type = 'Performance Absorber';
        else if (variant.includes('SPORT')) type = 'Sport Spring';
        return p.MODEL === selectedModel && type === selectedType;
      });

      if (filtered.length === 0) {
        productListEl.innerHTML = '<p class="text-gray-500 text-center py-4">No products found for this selection.</p>';
        return;
      }

      productListEl.innerHTML = `
        <div class="bg-gray-50 rounded-xl shadow-md overflow-hidden p-4 flex flex-col items-center text-center">
          <h4 class="font-bold text-lg text-gray-800">${(filtered[0].MODEL + ' ' + selectedType).toUpperCase()}</h4>
          <div class="mt-4 w-full flex flex-col gap-2">
            ${filtered.map(product => `
              <div class="flex justify-between items-center bg-white rounded-lg p-3 shadow-sm border border-gray-100">
                <div class="flex flex-col text-left">
                  <span class="font-medium text-gray-800">${product.POSITION} (${product.QUANTITY} pcs/set)</span>
                  <span class="text-blue-600 font-bold text-xl">RM ${Number(product.PRICE).toFixed(2)}</span>
                </div>
                <div class="flex items-center gap-2">
                  <button type="button" onclick="decreaseCartQuantity('${product.CODE}')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded-lg">-</button>
                  <span id="qty-${product.CODE}" class="w-8 text-center">${getCartQuantity(product.CODE)}</span>
                  <button type="button" onclick="increaseCartQuantity('${product.CODE}')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded-lg">+</button>
                  <button type="button" onclick="addToCart('${product.CODE}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 active:scale-95">Add</button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Cart helpers
    function getCartQuantity(productId) {
      const item = cart.find(i => i.CODE === productId);
      return item ? item.cartQuantity : 0;
    }

    window.addToCart = function(productId) {
      const product = products.find(p => p.CODE === productId);
      if (!product) return;
      const existing = cart.find(i => i.CODE === productId);
      if (existing) existing.cartQuantity += 1;
      else cart.push({ ...product, cartQuantity: 1 });
      renderProducts();
      renderCart();
    };

    window.increaseCartQuantity = function(productId) {
      const existing = cart.find(i => i.CODE === productId);
      if (existing) existing.cartQuantity += 1;
      else window.addToCart(productId);
      renderProducts();
      renderCart();
    };

    window.decreaseCartQuantity = function(productId) {
      const existing = cart.find(i => i.CODE === productId);
      if (!existing) return;
      existing.cartQuantity = Math.max(0, existing.cartQuantity - 1);
      if (existing.cartQuantity === 0) cart = cart.filter(i => i.CODE !== productId);
      renderProducts();
      renderCart();
    };

    function renderCart() {
      cartItemsEl.innerHTML = cart.map(item => `
        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
          <span>${item.MODEL} ${item.POSITION} (${item.QUANTITY} pcs)</span>
          <span>RM ${(Number(item.PRICE) * item.cartQuantity).toFixed(2)}</span>
        </div>
      `).join('');

      const total = cart.reduce((sum, item) => sum + Number(item.PRICE) * item.cartQuantity, 0);
      cartTotalEl.textContent = `RM ${total.toFixed(2)}`;
      cartItemCountEl.textContent = cart.reduce((sum, item) => sum + item.cartQuantity, 0);

      checkoutButton.disabled = cart.length === 0;
      checkoutButton.classList.toggle('opacity-50', cart.length === 0);
      checkoutButton.classList.toggle('cursor-not-allowed', cart.length === 0);
    }

    function renderCheckoutSummary() {
      checkoutSummaryEl.innerHTML = cart.map(item => `
        <div class="flex justify-between items-center border-b py-2">
          <span>${item.MODEL} ${item.POSITION} × ${item.cartQuantity}</span>
          <span>RM ${(Number(item.PRICE) * item.cartQuantity).toFixed(2)}</span>
        </div>
      `).join('');
    }

    // Live courier options from backend (EasyParcel)
async function renderCourierOptions(postcode = '43000', weight = 3.0) {
  try {
    const res = await fetch('/api/easyparcel', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ postcode, weight })
    });

    const couriers = await res.json();

    courierOptionsEl.innerHTML = couriers.map(c => `
      <label class="block mb-2">
        <input type="radio" name="courier" value="${c.courier_id}" data-price="${c.price}">
        ${c.courier_name} (RM ${Number(c.price).toFixed(2)})
      </label>
    `).join('');
  } catch (err) {
    courierOptionsEl.innerHTML = '<p class="text-red-600">Failed to load courier options.</p>';
    console.error('EasyParcel error:', err);
  }
}


    // Modal logic
    cartButton.addEventListener('click', () => {
      renderCart();
      cartModal.classList.remove('hidden');
    });

    closeCartBtn.addEventListener('click', () => {
      cartModal.classList.add('hidden');
    });

    // Open checkout and load courier options
checkoutButton.addEventListener('click', () => {
  if (cart.length > 0) {
    cartModal.classList.add('hidden');
    renderCheckoutSummary();
    // Call EasyParcel via backend and render options
    renderCourierOptions(); // pass actual postcode/weight if available
    checkoutModal.classList.remove('hidden');
  }
});


    closeCheckoutBtn.addEventListener('click', () => {
      checkoutModal.classList.add('hidden');
    });

  // Create ToyyibPay bill and redirect
  payButton.addEventListener('click', async () => {
  const name = document.getElementById('name')?.value || '';
  const email = document.getElementById('email')?.value || '';
  const phone = document.getElementById('phone')?.value || '';

  const selectedCourier = document.querySelector('input[name="courier"]:checked');
  const courierPrice = selectedCourier ? Number(selectedCourier.dataset.price) : 0;

  const cartTotal = cart.reduce((sum, item) => sum + Number(item.PRICE) * item.cartQuantity, 0);
  const finalAmount = cartTotal + courierPrice;

  if (!name || !email || !phone) {
    alert('Please fill in name, email, and phone.');
    return;
  }
  if (!selectedCourier) {
    alert('Please select a courier option.');
    return;
  }

  try {
    const res = await fetch('/api/toyyibpay', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, phone, amount: finalAmount })
    });

    const { url } = await res.json();
    if (url) {
      window.location.href = url;
    } else {
      alert('Payment URL not received.');
    }
  } catch (err) {
    alert('Payment initialization failed.');
    console.error('ToyyibPay error:', err);
  }
});


    closeConfirmationBtn.addEventListener('click', () => {
      confirmationModal.classList.add('hidden');
      cart = []; // reset cart
      renderProducts();
      renderCart();
    });

    // Initial load and bindings
    updateProductTypeDropdown();
    carModelSelect.addEventListener('change', updateProductTypeDropdown);
    productTypeSelect.addEventListener('change', renderProducts);
  });
</script>

</body>
</html>







